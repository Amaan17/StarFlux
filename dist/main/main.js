"use strict";var Y=Object.create;var L=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var K=Object.getOwnPropertyNames;var Q=Object.getPrototypeOf,X=Object.prototype.hasOwnProperty;var Z=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of K(t))!X.call(e,i)&&i!==n&&L(e,i,{get:()=>t[i],enumerable:!(s=G(t,i))||s.enumerable});return e};var R=(e,t,n)=>(n=e!=null?Y(Q(e)):{},Z(t||!e||!e.__esModule?L(n,"default",{value:e,enumerable:!0}):n,e));var a=require("electron"),c=R(require("node:path")),l=R(require("node:fs/promises")),w=require("node:fs"),P=require("node:crypto"),S=require("node:child_process"),v=require("electron"),q=!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development",m=null;function tt(){return c.default.join(__dirname,"../preload/preload.js")}async function I(){m=new a.BrowserWindow({width:1200,height:800,show:!1,backgroundColor:"#111827",webPreferences:{preload:tt(),contextIsolation:!0,nodeIntegration:!1,sandbox:!1,spellcheck:!1}}),m.on("ready-to-show",()=>m?.show()),m.on("closed",()=>m=null);let e=process.env.VITE_DEV_SERVER_URL||"http://localhost:5173",t=c.default.join(__dirname,"../renderer/index.html");if(process.env.VITE_DEV_SERVER_URL){await m.loadURL(e),m.webContents.openDevTools({mode:"detach"});return}if(q)try{await m.loadURL(e),m.webContents.openDevTools({mode:"detach"});return}catch{}await m.loadFile(t)}var j=()=>c.default.join(a.app.getPath("userData"),"notes");async function O(){let e=j();(0,w.existsSync)(e)||await l.default.mkdir(e,{recursive:!0})}async function et(){await O();let e=j(),n=(await l.default.readdir(e,{withFileTypes:!0})).filter(r=>r.isFile()&&(r.name.endsWith(".md")||r.name.endsWith(".html"))),s=new Map;for(let r of n){let o=r.name.replace(/\.(md|html)$/i,""),d=c.default.join(e,r.name),u=await l.default.stat(d),f=s.get(o);(!f||u.mtimeMs>f.stat.mtimeMs)&&s.set(o,{name:r.name,stat:u})}let i=await Promise.all(Array.from(s.entries()).map(async([r,o])=>{let d=c.default.join(e,o.name),u=await l.default.readFile(d,"utf8"),f="Untitled";if(o.name.endsWith(".html")){let h=u.match(/<h1[^>]*>(.*?)<\/h1>/i);h?f=h[1].replace(/<[^>]+>/g,"").trim()||"Untitled":f=u.replace(/<[^>]+>/g," ").split(/\s+/).slice(0,8).join(" ").trim()||"Untitled"}else f=(u.split(/\r?\n/).find(h=>h.trim().length>0)||"Untitled").replace(/^#\s*/,"");return{id:r,title:f,updatedAt:o.stat.mtimeMs}}));return i.sort((r,o)=>o.updatedAt-r.updatedAt),i}async function nt(e){let t=c.default.join(j(),`${e}.html`),n=c.default.join(j(),`${e}.md`),s=(0,w.existsSync)(t)?t:(0,w.existsSync)(n)?n:null;if(!s)return null;let i=await l.default.readFile(s,"utf8");return{id:e,content:i}}async function st(e){await O();let t=e.id||(0,P.randomUUID)(),n=c.default.join(j(),`${t}.html`);return await l.default.writeFile(n,e.content??"","utf8"),{id:t}}async function it(e){let t=c.default.join(j(),`${e}.html`),n=c.default.join(j(),`${e}.md`),s=!1;return(0,w.existsSync)(t)&&(await l.default.unlink(t),s=!0),(0,w.existsSync)(n)&&(await l.default.unlink(n),s=!0),s}var B=()=>c.default.join(a.app.getPath("userData"),"shortcuts.json"),y=[],V=()=>c.default.join(a.app.getPath("userData"),"launchers.json"),D=[];async function at(){let e=B();try{let t=await l.default.readFile(e,"utf8");y=JSON.parse(t)}catch{y=[]}}async function C(){let e=B();await l.default.writeFile(e,JSON.stringify(y,null,2),"utf8")}function T(){if(m)for(let e of y)try{a.globalShortcut.register(e.accelerator,()=>{if(e.action==="show-command-palette"){m?.webContents.send("shortcuts:fired",{id:e.id,action:e.action});return}if(e.action==="focus-notes"){m?.webContents.send("shortcuts:fired",{id:e.id,action:e.action});return}if(e.action.startsWith("open-url:")){let t=e.action.slice(9);a.shell.openExternal(t);return}if(e.action.startsWith("open-path:")){let t=e.action.slice(10);a.shell.openPath(t);return}if(e.action.startsWith("launcher:")){let t=e.action.slice(9),n=D.find(s=>s.id===t);n&&(n.kind==="url"?a.shell.openExternal(n.target):a.shell.openPath(n.target));return}m?.webContents.send("shortcuts:fired",{id:e.id,action:e.action})})}catch{}}function M(){a.globalShortcut.unregisterAll()}a.app.on("ready",async()=>{await I(),await at(),await rt(),T()});a.app.on("will-quit",()=>{M()});a.app.on("window-all-closed",()=>{process.platform!=="darwin"&&a.app.quit()});a.app.on("activate",()=>{a.BrowserWindow.getAllWindows().length===0&&I()});a.ipcMain.handle("notes:list",async()=>et());a.ipcMain.handle("notes:get",async(e,t)=>nt(t));a.ipcMain.handle("notes:save",async(e,t)=>st(t));a.ipcMain.handle("notes:delete",async(e,t)=>it(t));a.ipcMain.handle("shortcuts:list",async()=>y);a.ipcMain.handle("shortcuts:register",async(e,t)=>{let n={id:(0,P.randomUUID)(),...t};return y.push(n),await C(),M(),T(),n});a.ipcMain.handle("shortcuts:unregister",async(e,t)=>(y=y.filter(n=>n.id!==t),await C(),M(),T(),!0));a.ipcMain.handle("shortcuts:clear",async()=>(y=[],await C(),M(),!0));a.ipcMain.on("openExternal",(e,t)=>{a.shell.openExternal(t)});a.ipcMain.on("openPath",(e,t)=>{a.shell.openPath(t)});a.ipcMain.handle("paths:get",async(e,t)=>a.app.getPath(t));var x=new Map;function H(e){if(e&&(0,w.existsSync)(e))return e;let t=[],n=process.platform==="win32"?"yt-dlp.exe":"yt-dlp";try{t.push(c.default.join(process.cwd(),n))}catch{}try{t.push(c.default.join(a.app.getAppPath(),n))}catch{}for(let s of t)try{if((0,w.existsSync)(s))return s}catch{}return n}a.ipcMain.handle("yt:check",async(e,t)=>new Promise(n=>{try{let s=H(t),i=(0,S.spawn)(s,["--version"]),r="",o="";i.stdout.on("data",d=>r+=String(d)),i.stderr.on("data",d=>o+=String(d)),i.on("error",d=>n({ok:!1,error:d.message})),i.on("close",d=>{n(d===0?{ok:!0,version:r.trim()}:{ok:!1,error:o.trim()||`exit ${d}`})})}catch(s){n({ok:!1,error:s?.message||"unknown error"})}}));a.ipcMain.handle("yt:download",async(e,t)=>{let n=(0,P.randomUUID)(),s=H(t.ytDlpPath),i=[];t.format==="mp3"?i.push("-x","--audio-format","mp3"):t.format==="mp4"&&i.push("-f","mp4"),t.singleOnly&&i.push("--no-playlist"),typeof t.maxDownloads=="number"&&t.maxDownloads>0&&i.push("--max-downloads",String(t.maxDownloads)),t.ffmpegPath&&t.ffmpegPath.trim().length>0&&i.push("--ffmpeg-location",t.ffmpegPath);let r=c.default.join(t.outputDir,"%(title)s.%(ext)s");i.push("-o",r,t.url);let o=m;if(!o)throw new Error("No window");let d=(0,S.spawn)(s,i,{windowsHide:!0});x.set(n,d);let u=f=>o.webContents.send("yt:progress",{id:n,...f});return d.stdout.on("data",f=>{let h=String(f),k=h.match(/\[download\]\s+(\d+\.?\d*)%/);u({text:h,percent:k?parseFloat(k[1]):void 0})}),d.stderr.on("data",f=>u({text:String(f)})),await new Promise(f=>{d.on("close",h=>{u({done:!0,code:h}),x.delete(n),f({id:n,success:h===0,code:h})}),d.on("error",h=>{u({error:h.message}),x.delete(n),f({id:n,success:!1,code:null})})})});a.ipcMain.handle("yt:kill",async(e,t)=>{let n=x.get(t);if(!n)return!1;try{return n.kill(),setTimeout(()=>{if(!n.killed)try{process.platform==="win32"&&n.pid&&(0,S.spawn)("taskkill",["/PID",String(n.pid),"/T","/F"])}catch{}},500),!0}catch{return!1}finally{x.delete(t)}});a.ipcMain.handle("dialog:pickDir",async()=>{let e=await a.dialog.showOpenDialog({properties:["openDirectory","createDirectory"]});return e.canceled||e.filePaths.length===0?null:e.filePaths[0]});async function rt(){let e=V();try{let t=await l.default.readFile(e,"utf8");D=JSON.parse(t)}catch{D=[]}}async function J(){await l.default.writeFile(V(),JSON.stringify(D,null,2),"utf8")}a.ipcMain.handle("launchers:list",async()=>D);a.ipcMain.handle("launchers:add",async(e,t)=>{let n={id:(0,P.randomUUID)(),...t};return D.push(n),await J(),n});a.ipcMain.handle("launchers:remove",async(e,t)=>(D=D.filter(n=>n.id!==t),await J(),!0));a.ipcMain.handle("launchers:open",async(e,t)=>{let n=D.find(s=>s.id===t);return n?(n.kind==="url"?await a.shell.openExternal(n.target):await a.shell.openPath(n.target),!0):!1});a.ipcMain.handle("bin:locate",async(e,t)=>await new Promise(n=>{try{let s=process.platform==="win32"?"where":"which",i=(0,S.spawn)(s,[t],{windowsHide:!0}),r="";i.stdout.on("data",o=>r+=String(o)),i.on("error",()=>n(null)),i.on("close",o=>{if(o===0){let d=r.split(/\r?\n/).map(u=>u.trim()).filter(Boolean)[0];n(d||null)}else n(null)})}catch{n(null)}}));async function ot(e){let t=Math.max(1,Math.min(2e5,e.maxEntries??2e5)),n=Math.max(0,e.minSizeBytes??0),s=t,i=0,r=0,o=0,d=Date.now();function u(p){let b=Date.now();m&&(p||b-d>200)&&(d=b,m.webContents.send("du:progress",{files:i,dirs:r,bytes:o,hint:p}))}async function f(p){try{return await l.default.stat(p)}catch{return null}}async function h(p){let b=await f(p),_={path:p,name:c.default.basename(p)||p,size:0,isDir:!!b?.isDirectory()};if(!b)return _;if(!b.isDirectory())return _.size=b.size,i++,o+=b.size,u(),_;let $=0,F=[];try{let A=await l.default.readdir(p,{withFileTypes:!0});for(let E of A){let N=c.default.join(p,E.name);if(E.isDirectory()){let W=await h(N);$+=W.size,r++,s>0&&(F.push(W),s--)}else{let z=(await f(N))?.size||0;$+=z,i++,o+=z,z>=n&&s>0&&(F.push({path:N,name:E.name,size:z,isDir:!1}),s--)}u(p)}}catch{}return F.sort((A,E)=>E.size-A.size),_.children=F,_.size=$,_}let k=await h(e.root);return u("done"),k}a.ipcMain.handle("du:scan",async(e,t)=>ot(t));var g=()=>c.default.join(a.app.getPath("userData"),"images");async function U(){let e=g();(0,w.existsSync)(e)||await l.default.mkdir(e,{recursive:!0})}function ct(e){let t=e.match(/^data:(image\/(png|jpeg|jpg|webp|gif));base64,/i);if(!t)return".png";let n=t[2].toLowerCase();return n==="jpeg"?".jpg":`.${n}`}a.ipcMain.handle("images:list",async()=>{await U();let e=g(),t=await l.default.readdir(e,{withFileTypes:!0}),n=await Promise.all(t.filter(s=>s.isFile()).map(async s=>{let i=c.default.join(e,s.name),r=await l.default.stat(i);return{id:c.default.parse(s.name).name,name:s.name,path:i,size:r.size,addedAt:r.mtimeMs}}));return n.sort((s,i)=>i.addedAt-s.addedAt),n});a.ipcMain.handle("images:addDataUrl",async(e,t)=>{await U();let n=ct(t.dataUrl),s=(0,P.randomUUID)(),i=c.default.join(g(),`${s}${n}`),r=t.dataUrl.split(",")[1]||"",o=Buffer.from(r,"base64");await l.default.writeFile(i,o);let d=await l.default.stat(i);return{id:s,name:c.default.basename(i),size:d.size,addedAt:d.mtimeMs}});a.ipcMain.handle("images:addCopy",async(e,t)=>{await U();let n=c.default.extname(t)||".png",s=(0,P.randomUUID)(),i=c.default.join(g(),`${s}${n}`);await l.default.copyFile(t,i);let r=await l.default.stat(i);return{id:s,name:c.default.basename(i),size:r.size,addedAt:r.mtimeMs}});a.ipcMain.handle("images:delete",async(e,t)=>{let n=g(),s=(await l.default.readdir(n)).filter(i=>i.startsWith(t+"."));for(let i of s){let r=c.default.join(n,i);try{await l.default.unlink(r)}catch{}}return!0});a.ipcMain.handle("images:getPath",async(e,t)=>{let n=g(),s=(await l.default.readdir(n)).find(i=>i.startsWith(t+"."));return s?c.default.join(n,s):null});function lt(e){let t=c.default.extname(e).toLowerCase();return t===".png"?"image/png":t===".jpg"||t===".jpeg"?"image/jpeg":t===".webp"?"image/webp":t===".gif"?"image/gif":"application/octet-stream"}a.ipcMain.handle("images:getDataUrl",async(e,t)=>{let n=g(),s=(await l.default.readdir(n)).find(r=>r.startsWith(t+"."));if(!s)return null;let i=c.default.join(n,s);try{let r=await l.default.readFile(i);return`data:${lt(i)};base64,${r.toString("base64")}`}catch{return null}});a.ipcMain.handle("images:copyToClipboard",async(e,t)=>{let n=await a.ipcMain.emit,s=g(),i=(await l.default.readdir(s)).find(o=>o.startsWith(t+"."));if(!i)return!1;let r=c.default.join(s,i);try{let o=v.nativeImage.createFromPath(r);return v.clipboard.writeImage(o),!0}catch{return!1}});a.ipcMain.handle("images:saveAs",async(e,t)=>{let n=g(),s=(await l.default.readdir(n)).find(o=>o.startsWith(t+"."));if(!s)return!1;let i=c.default.join(n,s),r=await a.dialog.showSaveDialog({defaultPath:s});return r.canceled||!r.filePath?!1:(await l.default.copyFile(i,r.filePath),!0)});a.ipcMain.handle("images:addByUrl",async(e,t)=>{await U();try{let n=await fetch(t);if(!n.ok)throw new Error(`HTTP ${n.status}`);let s=Buffer.from(await n.arrayBuffer()),i=(n.headers.get("content-type")||"").toLowerCase(),r=".png";i.includes("jpeg")?r=".jpg":i.includes("png")?r=".png":i.includes("webp")?r=".webp":i.includes("gif")&&(r=".gif");let o=(0,P.randomUUID)(),d=c.default.join(g(),`${o}${r}`);await l.default.writeFile(d,s);let u=await l.default.stat(d);return{id:o,name:c.default.basename(d),size:u.size,addedAt:u.mtimeMs}}catch(n){throw new Error(`download failed: ${n.message}`)}});
